# Simulation 1 and 2  
# by Said Jimenez
# Here I will try to emulate the code from the Major Depression as a Complex System paper from Cramer

pacman::p_load(tidyverse, IsingSampler, IsingFit, qgraph, bootnet)

# Data can be downloaded here: https://dataverse.nl/dataset.xhtml?persistentId=doi:10.34894/NVROJB
load("dataverse_files/vonKlipstein2021.RData")

data <- 
  shareD %>% 
  filter(time == 0) %>% 
  tibble()

items <- 
  data %>% 
  select(BPDSI1.1:BPDSI9.8) 

items_bin <- 
  items %>% 
  mutate(
    across(
      .cols = everything(),
      .fns = ~ ifelse(is.na(.x), median(.x, na.rm = T), .x)
    )
  ) %>% 
  mutate(
    across(
      .cols = everything(),
      .fns = ~ ifelse(.x >= mean(.x), 1, 0)
    )
  ) 



fit_net <- estimateNetwork(items_bin, default = "IsingFit")  


estimated_weights <- fit_net$results$weiadj
estimated_thresholds <- fit_net$results$thresholds


##### Simulation I -------


simulation_vulnerability <- function(c = .8) {
  
  set.seed(2022)
  
  I <- 1500
  
  W <- estimated_weights
  b <- abs(estimated_thresholds)
  c <- c
  
  # X = np.zeros(b.shape, np.bool)
  X <- rep(0L, length(b)) 
  
  # D = np.empty(I, np.uint8)
  D <- rep(0L, I)
  
  for (i in 1:I) {
    
    A <- rowSums(c * W * X)
    
    # The more the total activation exceeds 
    # the threshold of symptom i at time t, 
    # the higher the probability that symptom i
    # becomes active 
    P <- 1 / (1 + exp(b - A))
    
    X <- P > runif(length(P), 0, 1)
    
    D[i] <- sum(X)
    
  }
  
  return(D)
}

activations <- map(c(.2, 1.1, 3), simulation_vulnerability)

vul_labs <- c("Weak = 0.2", "Medium = 1.1", "Strong = 3.0")

names(activations) <- vul_labs


df_sim <- 
  bind_rows(activations, .id = "Vulnerability") %>% 
  mutate(Time = 1:n()) %>% 
  pivot_longer(
    cols = 1:3,
    names_to = "Vulnerability", 
    values_to = "Activation"
  ) %>% 
  mutate(
    Vulnerability = factor(Vulnerability, levels = vul_labs)
  )


fig_sim1 <- 
  ggplot(df_sim, aes(x = Time, y = Activation, fill = Vulnerability, col = Vulnerability)) +
  geom_area(alpha = 0.5, show.legend = F) +
  geom_rug(sides = "l", show.legend = F) +
  facet_wrap(~Vulnerability, ncol = 1) +
  scale_y_continuous(limits = c(0, 70)) +
  scale_fill_brewer(type = "qual", palette = 6, direction = -1) +
  scale_color_brewer(type = "qual", palette = 6, direction = -1) +
  labs(y = "State (D)") +
  theme_bw(base_size = 18) +
  theme(strip.text = element_text(face = "bold", hjust = 0.5))
  
  
fig_sim1

df_sim %>% 
  group_by(Vulnerability) %>% 
  summarize(
    n = n(), 
    mean = mean(Activation), 
    sd = sd(Activation), 
    median = median(Activation), 
    min = min(Activation), 
    max = max(Activation),
    Q1 = quantile(Activation, prob = .25), 
    Q3 = quantile(Activation, prob = .75)
  )

# Simulation 2 ------------------------------------------------------------

I <- 10000

S <- c(seq(-15, 15, length.out = I/2), seq(15, -15, length.out = I/2))

simulation_stress <- function(c = 1.10) {
  
  
  set.seed(2022)
  
  I <- 10000
  
  W <- estimated_weights
  b <- abs(estimated_thresholds)
  c <- c
  
  # X = np.zeros(b.shape, np.bool)
  X <- rep(0L, length(b)) 
  
  # D = np.empty(I, np.uint8)
  D <- rep(0L, I)
  
  S <- c(seq(-15, 15, length.out = I/2), seq(15, -15, length.out = I/2))
  
  
  for (i in 1:I) {
    
    A <- rowSums(c * W * X + S[i])
    
    # The more the total activation exceeds 
    # the threshold of symptom i at time t, 
    # the higher the probability that symptom i
    # becomes active 
    P <- 1 / (1 + exp(b - A))
    
    X <- P > runif(length(P), 0, 1)
    
    D[i] <- sum(X)
  }
  
  return(D)
}

activations_stress <- map(c(0.2, 1.1, 3.0, 10), simulation_stress)

names(activations_stress) <- c(vul_labs, "Extreme = 10.0")

df_sim2 <- 
  activations_stress %>% 
  bind_rows(.id = "Vulnerability") %>% 
  mutate(Time = 1:n()) %>% 
  pivot_longer(
    cols = 1:4,
    names_to = "Vulnerability", 
    values_to = "Activation"
  ) %>% 
  split(.$Vulnerability) %>% 
  map(
    .f = ~ .x %>% 
      mutate(
        S = S,
        delta_stress = gl(2, k = I/2, labels = c("Increase", "Decrease")),
        S_intervals = cut(S, breaks = 200)
        )
      ) %>% 
  bind_rows(.id = "Vulnerability") %>% 
  mutate(Vulnerability = factor(Vulnerability, levels = c(vul_labs, "Extreme = 10.0"))) 


fig_sim2 <- 
  df_sim2 %>% 
  filter(S > -.70, S < .50) %>% 
  group_by(Vulnerability, S_intervals, delta_stress) %>% 
  summarize(D_prom = mean(Activation), .groups = "drop") %>% 
  ggplot(aes(x = S_intervals, 
             y = D_prom, 
             col = delta_stress, 
             group = delta_stress, 
             lty = delta_stress)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  scale_color_brewer(type = "qual", palette = 6) + 
  facet_wrap(~Vulnerability, ncol = 2) +
  labs(
    x = "Stress", 
    y = "State (D)",
    col = NULL,
    group = NULL,
    lty = NULL
  ) +
  theme_bw(base_size = 18) +
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "top", 
    axis.text.x = element_text(angle = 45, 
                               size = 7, 
                               margin = margin(t = .35, unit = "cm"))
    )

fig_sim2

ggsave(plot = fig_sim1, filename = "fig_sim1.png", device = "png", 
       dpi = 350, units = "cm", height = 25, width = 25)

ggsave(plot = fig_sim2, filename = "fig_sim2.png", device = "png", 
       dpi = 350, units = "cm", height = 15, width = 20)
